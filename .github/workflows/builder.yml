name: AI Kodular Builder

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Read user prompt
        id: prompt
        run: |
          if [ -f prompt.txt ]; then
            echo "::set-output name=content::$(cat prompt.txt)"
          else
            echo "::set-output name=content::Create a simple hello world app"
          fi

      - name: Call Gemini API
        id: gemini
        env:
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PROMPT_CONTENT="${{ steps.prompt.outputs.content }}"
          JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT_CONTENT" '{
            "contents": [{
              "parts": [{
                "text": "You are a Kodular project generator. Your task is to take a user prompt and generate the content for the Screen1.scm file in valid JSON format. The JSON should represent the UI components and their properties. Do not include any explanations, only the raw JSON content. Here is the user prompt: \($prompt)"
              }]
            }]
          }')
              
          RESPONSE=$(curl -s -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=$API_KEY")
              
          AI_RESPONSE=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text' | sed 's/```json//g' | sed 's/```//g')
              
          echo "::set-output name=ai_json::$AI_RESPONSE"

      - name: Create Kodular Project Files
        run: |
          AI_JSON="${{ steps.gemini.outputs.ai_json }}"
          mkdir -p src/appinventor/ai_user
              
          # Create project.properties
          echo "name=AvatarProject" > project.properties
          echo "version=1.0" >> project.properties
          echo "theme=AppTheme.Light.DarkActionBar" >> project.properties
              
          # Create Screen1.scm
          echo "$AI_JSON" > src/appinventor/ai_user/Screen1.scm
              
          # Create Screen1.bky (empty for now)
          echo "" > src/appinventor/ai_user/Screen1.bky

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: Generate Kodular project files from AI"
            git push
          fi

